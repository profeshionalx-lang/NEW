<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grechka ‚Ä¢ –¢—É—Ä–Ω–∏—Ä—ã</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>* { font-family: 'Inter', sans-serif; }</style>
    <script src="./js/config.js"></script>
    <script type="text/babel" src="./js/shared.js"></script>
</head>
<body class="bg-black">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // MOBILE-FIRST TournamentCard
        function TournamentCard({ tournament: t, canDelete, onDelete }) {
            const isMobile = window.useIsMobile();
            const status = t.status === 'completed' ? 'completed' : (t.status === 'stage1' || t.status === 'stage2') ? 'active' : 'default';
            
            return (
                <a href={`./tournament.html?id=${t.id}`} className="block no-underline">
                    <window.Card className={window.cn(
                        'p-4 md:p-6 cursor-pointer transition-all h-full relative',
                        'active:scale-[0.98]' // Touch feedback –≤–º–µ—Å—Ç–æ hover
                    )}>
                        <div className="flex justify-between items-start mb-3 md:mb-4">
                            <window.Badge variant={status}>
                                {status === 'active' ? 'LIVE' : status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}
                            </window.Badge>
                            {canDelete && (
                                <button 
                                    onClick={(e) => {
                                        e.preventDefault(); 
                                        e.stopPropagation();
                                        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä "${t.name}"?`)) {
                                            onDelete(t.id);
                                        }
                                    }} 
                                    className={window.cn(
                                        'text-gray-300 active:text-red-500 z-10 transition-all',
                                        'min-w-[44px] min-h-[44px] flex items-center justify-center',
                                        '-mr-2 -mt-2', // –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ –Ω–∞–∂–∞—Ç–∏—è
                                        isMobile ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'
                                    )}
                                >
                                    <span className="text-xl">‚úï</span>
                                </button>
                            )}
                        </div>
                        
                        <h3 className="text-xl md:text-2xl font-bold text-black mb-3 md:mb-4 leading-tight">
                            {t.name}
                        </h3>
                        
                        <div className="space-y-2 text-sm md:text-sm text-gray-500">
                            {t.date && (
                                <div className="flex items-center gap-2">
                                    <span>üìÖ</span>
                                    <span>{window.formatDate(t.date)}</span>
                                </div>
                            )}
                            {t.location && (
                                <div className="flex items-center gap-2">
                                    <span>üìç</span>
                                    <span className="truncate">{t.location}</span>
                                </div>
                            )}
                            {t.price && (
                                <div className="flex items-center gap-2">
                                    <span>üí∞</span>
                                    <span>{t.price}</span>
                                </div>
                            )}
                        </div>
                        
                        <div className="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-gray-100 flex justify-between items-center">
                            <div className="text-gray-500 text-sm md:text-base">
                                <span className="text-xl md:text-2xl font-bold text-black">
                                    {t.registeredPlayers?.length || 0}
                                </span>
                                <span className="text-gray-400"> / {t.maxPlayers || '‚àû'}</span>
                            </div>
                            <div className="text-gray-300 text-xl">‚Üí</div>
                        </div>
                    </window.Card>
                </a>
            );
        }

        // MOBILE-FIRST CreateTournament Form
        function CreateTournament({ onSubmit, onCancel }) {
            const [form, setForm] = useState({ 
                name: '', 
                date: '', 
                time: '', 
                location: '', 
                price: '', 
                maxPlayers: 16, 
                courts: 2, 
                format: 'fixed' 
            });
            const u = (k, v) => setForm(f => ({ ...f, [k]: v }));
            const isMobile = window.useIsMobile();
            
            return (
                <div className="max-w-2xl mx-auto">
                    <window.Button 
                        variant="ghost" 
                        onClick={onCancel} 
                        className="mb-6 md:mb-8"
                    >
                        ‚Üê –ù–∞–∑–∞–¥
                    </window.Button>
                    
                    <window.Card className="p-6 md:p-8">
                        <h2 className="text-2xl md:text-3xl font-bold text-black mb-6 md:mb-8">
                            –ù–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä
                        </h2>
                        
                        <div className="space-y-5 md:space-y-6">
                            {/* –ù–∞–∑–≤–∞–Ω–∏–µ */}
                            <window.Input 
                                label="–ù–∞–∑–≤–∞–Ω–∏–µ" 
                                value={form.name} 
                                onChange={e => u('name', e.target.value)} 
                                placeholder="Sunday Cup"
                                autoComplete="off"
                            />
                            
                            {/* –§–æ—Ä–º–∞—Ç - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π grid */}
                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-3">
                                    –§–æ—Ä–º–∞—Ç
                                </label>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                    {[
                                        ['fixed', 'üë´ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã'], 
                                        ['rotating', 'üîÑ –°–º–µ–Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤']
                                    ].map(([val, title]) => (
                                        <button 
                                            key={val} 
                                            type="button" 
                                            onClick={() => u('format', val)} 
                                            className={window.cn(
                                                'p-4 rounded-xl md:rounded-2xl border-2 text-left transition-all',
                                                'min-h-[56px]', // Touch-friendly
                                                form.format === val 
                                                    ? 'border-black bg-black text-white' 
                                                    : 'border-gray-200 bg-white text-gray-700 active:border-gray-400'
                                            )}
                                        >
                                            <div className="font-semibold text-sm md:text-base">
                                                {title}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* –î–∞—Ç–∞ –∏ –í—Ä–µ–º—è - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π grid */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                <window.Input 
                                    label="–î–∞—Ç–∞" 
                                    type="date" 
                                    value={form.date} 
                                    onChange={e => u('date', e.target.value)}
                                />
                                <window.Input 
                                    label="–í—Ä–µ–º—è" 
                                    type="time" 
                                    value={form.time} 
                                    onChange={e => u('time', e.target.value)}
                                />
                            </div>

                            {/* –õ–æ–∫–∞—Ü–∏—è */}
                            <window.Input 
                                label="–õ–æ–∫–∞—Ü–∏—è" 
                                value={form.location} 
                                onChange={e => u('location', e.target.value)} 
                                placeholder="–ê–¥—Ä–µ—Å –∫–ª—É–±–∞"
                                autoComplete="off"
                            />

                            {/* –¶–µ–Ω–∞, –£—á–∞—Å—Ç–Ω–∏–∫–∏, –ö–æ—Ä—Ç—ã - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π grid */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                <window.Input 
                                    label="–¶–µ–Ω–∞" 
                                    value={form.price} 
                                    onChange={e => u('price', e.target.value)} 
                                    placeholder="20 euro"
                                    autoComplete="off"
                                />
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-500 mb-2">
                                        –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                                    </label>
                                    <select 
                                        className={window.cn(
                                            'w-full p-4 min-h-[48px]',
                                            'bg-gray-50 border border-gray-200',
                                            'rounded-xl md:rounded-2xl',
                                            'text-base md:text-sm text-black',
                                            'focus:border-black focus:ring-1 focus:ring-black',
                                            'outline-none transition-all'
                                        )}
                                        value={form.maxPlayers} 
                                        onChange={e => u('maxPlayers', +e.target.value)}
                                    >
                                        {[8, 12, 16, 24, 32].map(n => (
                                            <option key={n} value={n}>{n}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <window.Input 
                                    label="–ö–æ—Ä—Ç–æ–≤" 
                                    type="number" 
                                    min="1" 
                                    max="10" 
                                    value={form.courts} 
                                    onChange={e => u('courts', +e.target.value)}
                                />
                            </div>

                            {/* –ö–Ω–æ–ø–∫–∏ - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π layout */}
                            <div className="flex flex-col md:flex-row gap-3 md:gap-4 pt-6 md:pt-8">
                                <window.Button 
                                    onClick={() => onSubmit(form)} 
                                    disabled={!form.name || !form.date || !form.location} 
                                    className="flex-1 disabled:opacity-30"
                                >
                                    –°–æ–∑–¥–∞—Ç—å
                                </window.Button>
                                <window.Button 
                                    variant="secondary" 
                                    onClick={onCancel} 
                                    className="bg-gray-100 text-black active:bg-gray-200 md:w-auto"
                                >
                                    –û—Ç–º–µ–Ω–∞
                                </window.Button>
                            </div>
                        </div>
                    </window.Card>
                </div>
            );
        }

        // MOBILE-FIRST TournamentList
        function TournamentList() {
            const { user, isAdmin } = window.useAuth();
            const [creating, setCreating] = useState(false);
            const allTournaments = window.useCollection('tournaments');
            const ready = window.useFirebaseReady();
            const isMobile = window.useIsMobile();
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
            const [initialLoad, setInitialLoad] = useState(true);
            
            useEffect(() => {
                if (ready && allTournaments.length >= 0) {
                    // –î–∞–µ–º 100ms —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                    const timer = setTimeout(() => setInitialLoad(false), 100);
                    return () => clearTimeout(timer);
                }
            }, [ready, allTournaments.length]);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º skeleton –ø–æ–∫–∞ –∏–¥–µ—Ç –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            if (!ready || initialLoad) {
                return <window.TournamentsListSkeleton />;
            }
            
            const tournaments = allTournaments
                .filter(t => !t.deleted)
                .sort((a, b) => new Date(a.date || a.createdAt) - new Date(b.date || b.createdAt));
            
            const groups = {
                upcoming: tournaments.filter(t => t.status === 'upcoming'),
                active: tournaments.filter(t => t.status === 'stage1' || t.status === 'stage2'),
                completed: tournaments.filter(t => t.status === 'completed')
            };

            const create = async (data) => {
                const id = 't_' + Date.now();
                await window.fb.doc('tournaments', id).set({ 
                    id, 
                    ...data, 
                    status: 'upcoming', 
                    deleted: false, 
                    createdAt: new Date().toISOString(), 
                    createdBy: user?.uid || null, 
                    registeredPlayers: [], 
                    pairs: [] 
                });
                window.location.href = `./tournament.html?id=${id}`;
            };

            const del = async (id) => { 
                if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä?')) {
                    await window.fb.doc('tournaments', id).update({ deleted: true }); 
                }
            };

            // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è
            const Section = ({ title, items, pulse, dim }) => items.length > 0 && (
                <section>
                    <div className="flex items-center gap-3 md:gap-4 mb-4 md:mb-6">
                        <div className={window.cn(
                            'w-2 h-2 rounded-full', 
                            dim ? 'bg-white/30' : 'bg-white', 
                            pulse && 'animate-pulse'
                        )} />
                        <h3 className={window.cn(
                            'text-xs md:text-sm font-medium tracking-widest uppercase', 
                            dim ? 'text-white/40' : 'text-white/60'
                        )}>
                            {title}
                        </h3>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        {items.map(t => (
                            <TournamentCard 
                                key={t.id} 
                                tournament={t} 
                                onDelete={del} 
                                canDelete={user && (user.email === CONFIG.ADMIN_EMAIL || t.createdBy === user.uid)} 
                            />
                        ))}
                    </div>
                </section>
            );

            if (creating) {
                return <CreateTournament onSubmit={create} onCancel={() => setCreating(false)} />;
            }

            return (
                <div className="space-y-8 md:space-y-12">
                    {/* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è - full width –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */}
                    <div className={window.cn(
                        isMobile ? 'w-full' : 'flex justify-end'
                    )}>
                        <window.Button 
                            onClick={() => setCreating(true)}
                            className={isMobile ? 'w-full' : ''}
                        >
                            + –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                        </window.Button>
                    </div>
                    
                    {/* Empty state */}
                    {groups.upcoming.length === 0 && groups.active.length === 0 ? (
                        <window.Card dark className="p-12 md:p-16 text-center">
                            <div className="text-5xl md:text-6xl mb-4 opacity-20">üéæ</div>
                            <p className="text-white/40 text-sm md:text-base">
                                –ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
                            </p>
                        </window.Card>
                    ) : (
                        <>
                            <Section title="–ü–†–ï–î–°–¢–û–Ø–©–ò–ï" items={groups.upcoming} />
                            <Section title="–°–ï–ô–ß–ê–° –ò–ì–†–ê–Æ–¢" items={groups.active} pulse />
                        </>
                    )}
                    
                    <Section title="–ó–ê–í–ï–†–®–Å–ù–ù–´–ï" items={groups.completed} dim />
                </div>
            );
        }

        function App() {
            const auth = window.useAuthState();
            return (
                <window.AuthContext.Provider value={auth}>
                    <window.Layout activePage="tournaments">
                        <TournamentList />
                    </window.Layout>
                </window.AuthContext.Provider>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
