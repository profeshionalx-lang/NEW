<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grechka ‚Ä¢ –¢—É—Ä–Ω–∏—Ä</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        /* Horizontal scroll styling –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
    </style>
    <script src="./js/config.js"></script>
    <script type="text/babel" src="./js/shared.js"></script>
</head>
<body class="bg-black">
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        // MOBILE-FIRST PairsEditor - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–ª—è touch
        function PairsEditor({ players, courts, onConfirm, onCancel }) {
            const [pairs, setPairs] = useState(() => {
                const shuffled = [...players].sort(() => Math.random() - 0.5);
                return Array(Math.ceil(shuffled.length / 2)).fill().map((_, i) => ({
                    id: i + 1, player1: shuffled[i * 2] || null, player2: shuffled[i * 2 + 1] || null
                }));
            });
            const isMobile = window.useIsMobile();

            const updatePlayerName = (pairIdx, slot, name) => {
                const newPairs = [...pairs];
                newPairs[pairIdx][slot] = newPairs[pairIdx][slot] 
                    ? { ...newPairs[pairIdx][slot], name } 
                    : { id: `manual_${Date.now()}`, name, photoURL: null };
                setPairs(newPairs);
            };

            const removePlayer = (pairIdx, slot) => {
                const newPairs = [...pairs];
                newPairs[pairIdx][slot] = null;
                setPairs(newPairs);
            };

            const PlayerSlot = ({ player, pairIdx, slot }) => {
                const [editing, setEditing] = useState(false);
                const [name, setName] = useState(player?.name || '');

                return (
                    <div className={window.cn(
                        'flex items-center gap-2 md:gap-3 p-3 md:p-3',
                        'rounded-xl border-2 transition-all',
                        'min-h-[56px]', // Touch-friendly
                        player 
                            ? 'border-gray-200 bg-white' 
                            : 'border-dashed border-gray-300 bg-gray-50'
                    )}>
                        {player ? (
                            <>
                                <window.Avatar src={player.photoURL} name={player.name} size="sm" />
                                {editing ? (
                                    <input 
                                        autoFocus 
                                        className="flex-1 bg-transparent border-b border-black outline-none text-black font-medium text-sm md:text-base" 
                                        value={name} 
                                        onChange={e => setName(e.target.value)} 
                                        onBlur={() => { 
                                            updatePlayerName(pairIdx, slot, name); 
                                            setEditing(false); 
                                        }} 
                                        onKeyDown={e => e.key === 'Enter' && e.target.blur()} 
                                    />
                                ) : (
                                    <span 
                                        className="flex-1 font-medium text-black text-sm md:text-base truncate"
                                        onClick={() => setEditing(true)}
                                    >
                                        {player.name}
                                    </span>
                                )}
                                <button 
                                    onClick={() => setEditing(true)} 
                                    className="text-gray-400 active:text-blue-500 p-2 min-w-[40px] min-h-[40px] flex items-center justify-center"
                                >
                                    <span className="text-lg">‚úèÔ∏è</span>
                                </button>
                                <button 
                                    onClick={() => removePlayer(pairIdx, slot)} 
                                    className="text-gray-400 active:text-red-500 p-2 min-w-[40px] min-h-[40px] flex items-center justify-center"
                                >
                                    <span className="text-lg">‚úï</span>
                                </button>
                            </>
                        ) : (
                            <input 
                                className="w-full bg-transparent text-center outline-none text-gray-400 placeholder-gray-300 text-sm md:text-base" 
                                placeholder="+ –î–æ–±–∞–≤–∏—Ç—å" 
                                value={name} 
                                onChange={e => setName(e.target.value)} 
                                onBlur={() => { 
                                    if (name.trim()) updatePlayerName(pairIdx, slot, name.trim()); 
                                    setName(''); 
                                }} 
                                onKeyDown={e => e.key === 'Enter' && e.target.blur()} 
                            />
                        )}
                    </div>
                );
            };

            return (
                <div className="max-w-3xl mx-auto">
                    <div className="flex items-center justify-between mb-6 md:mb-8">
                        <div>
                            <h2 className="text-2xl md:text-3xl font-bold text-white">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä
                            </h2>
                            <p className="text-white/60 mt-1 text-sm md:text-base">
                                {isMobile ? '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' : '–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏–≥—Ä–æ–∫–æ–≤'}
                            </p>
                        </div>
                        <window.Button variant="ghost" onClick={onCancel}>
                            <span className="text-xl">‚úï</span>
                        </window.Button>
                    </div>
                    
                    <window.Card className="p-4 md:p-6 mb-6">
                        <div className="space-y-3 md:space-y-4">
                            {pairs.map((pair, idx) => (
                                <div key={idx} className="flex items-center gap-3 md:gap-4">
                                    <div className="w-10 h-10 md:w-12 md:h-12 rounded-full bg-black text-white flex items-center justify-center font-black text-base md:text-lg shrink-0">
                                        {idx + 1}
                                    </div>
                                    <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3">
                                        <PlayerSlot player={pair.player1} pairIdx={idx} slot="player1" />
                                        <PlayerSlot player={pair.player2} pairIdx={idx} slot="player2" />
                                    </div>
                                    <button 
                                        onClick={() => setPairs(pairs.filter((_, i) => i !== idx))} 
                                        className="text-gray-300 active:text-red-500 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                                    >
                                        <span className="text-xl">üóëÔ∏è</span>
                                    </button>
                                </div>
                            ))}
                        </div>
                        <button 
                            onClick={() => setPairs([...pairs, { id: pairs.length + 1, player1: null, player2: null }])} 
                            className={window.cn(
                                'w-full mt-4 p-4 min-h-[52px]',
                                'border-2 border-dashed border-gray-200',
                                'rounded-xl text-gray-400',
                                'active:border-gray-400 transition-all',
                                'text-sm md:text-base'
                            )}
                        >
                            + –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                        </button>
                    </window.Card>
                    
                    <div className="flex flex-col md:flex-row gap-3 md:gap-4">
                        <window.Button 
                            onClick={() => onConfirm(pairs.filter(p => p.player1 || p.player2).map((p, i) => ({ 
                                id: i + 1, 
                                number: i + 1, 
                                player1: p.player1?.name || 'TBD', 
                                player2: p.player2?.name || 'TBD', 
                                player1Id: p.player1?.id, 
                                player2Id: p.player2?.id 
                            })))} 
                            className="flex-1 bg-black"
                        >
                            ‚úì –ù–∞—á–∞—Ç—å ({pairs.filter(p => p.player1 || p.player2).length} –ø–∞—Ä)
                        </window.Button>
                        <window.Button 
                            variant="secondary" 
                            onClick={onCancel} 
                            className="bg-gray-100 text-black md:w-auto"
                        >
                            –û—Ç–º–µ–Ω–∞
                        </window.Button>
                    </div>
                </div>
            );
        }

        // MOBILE-FIRST MatchCard
        function MatchCard({ match, onEdit, isAdmin }) {
            const hasResult = match.set1p1 !== '' && match.set1p2 !== '';
            const [p1, p2] = [parseInt(match.set1p1) || 0, parseInt(match.set1p2) || 0];
            const winner = hasResult ? (p1 > p2 ? 1 : p1 < p2 ? 2 : 0) : 0;
            const courtName = typeof match.court === 'object' ? match.court.name : `–ö–æ—Ä—Ç ${match.court}`;
            const isMobile = window.useIsMobile();

            return (
                <div className={window.cn(
                    'bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-3 md:p-3 mb-2',
                    'flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0'
                )}>
                    <div className="flex items-center gap-2 md:gap-3 text-white flex-1">
                        <span className="bg-white bg-opacity-30 px-2 md:px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap">
                            {courtName}
                        </span>
                        <span className="text-sm">
                            <strong className={winner === 1 ? 'text-green-300' : ''}>
                                #{match.pair1?.number}
                            </strong>
                            {' vs '}
                            <strong className={winner === 2 ? 'text-green-300' : ''}>
                                #{match.pair2?.number}
                            </strong>
                        </span>
                    </div>
                    
                    {hasResult ? (
                        <div className="flex gap-3 items-center w-full md:w-auto justify-between md:justify-end">
                            <span className="text-white font-black text-xl md:text-lg">
                                {match.set1p1}:{match.set1p2}
                            </span>
                            {isAdmin && (
                                <button 
                                    className={window.cn(
                                        'bg-white bg-opacity-30 text-white',
                                        'px-3 md:px-3 py-2 md:py-1',
                                        'rounded-lg text-sm md:text-xs font-bold',
                                        'active:bg-opacity-40 transition-all',
                                        'min-h-[44px] md:min-h-0'
                                    )}
                                    onClick={onEdit}
                                >
                                    ‚úé
                                </button>
                            )}
                        </div>
                    ) : isAdmin ? (
                        <button 
                            onClick={onEdit} 
                            className={window.cn(
                                'bg-white text-gray-900 font-bold',
                                'px-4 py-2 rounded-lg text-sm',
                                'min-h-[48px] w-full md:w-auto',
                                'active:bg-gray-100 transition-all'
                            )}
                        >
                            –í–≤–µ—Å—Ç–∏ —Å—á—ë—Ç
                        </button>
                    ) : (
                        <span className="text-white text-sm opacity-50 w-full md:w-auto text-right">
                            –û–∂–∏–¥–∞–Ω–∏–µ
                        </span>
                    )}
                </div>
            );
        }

        // MOBILE-FIRST GroupView —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
        function GroupView({ group, stage, onUpdateMatch, colorClass, isAdmin }) {
            const [editingMatch, setEditingMatch] = useState(null);
            const isMobile = window.useIsMobile();
            
            return (
                <div className={`bg-gradient-to-br ${colorClass} rounded-2xl md:rounded-3xl p-4 md:p-6 shadow-2xl`}>
                    <div className="text-2xl md:text-3xl font-black text-white mb-4 md:mb-6 text-center">
                        –ì–†–£–ü–ü–ê {group.name}
                    </div>
                    
                    {/* –¢–∞–±–ª–∏—Ü–∞ —Å horizontal scroll –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */}
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-4 mb-4 md:mb-6">
                        <div className="table-scroll">
                            <table className="w-full text-white text-xs md:text-sm min-w-[400px]">
                                <thead>
                                    <tr className="border-b border-white border-opacity-30">
                                        <th className="p-2 text-left font-bold">–ú</th>
                                        <th className="p-2 text-left font-bold">–ü–∞—Ä–∞</th>
                                        <th className="p-2 text-center font-bold">–ò</th>
                                        <th className="p-2 text-center font-bold">–û</th>
                                        <th className="p-2 text-center font-bold">+/-</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {group.pairs.map((pair, idx) => (
                                        <tr key={pair.id} className="border-b border-white border-opacity-20">
                                            <td className="p-2">
                                                <span className="font-black text-base md:text-lg">
                                                    {idx + 1}
                                                </span>
                                            </td>
                                            <td className="p-2">
                                                <div className="font-bold">#{pair.number}</div>
                                                <div className="text-xs opacity-90 truncate max-w-[150px]">
                                                    {pair.player1}/{pair.player2}
                                                </div>
                                            </td>
                                            <td className="p-2 text-center">{pair.played || 0}</td>
                                            <td className="p-2 text-center">
                                                <span className="font-black text-base md:text-lg">
                                                    {pair.points || 0}
                                                </span>
                                            </td>
                                            <td className={`p-2 text-center font-bold ${(pair.gamesDiff || 0) > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                {(pair.gamesDiff || 0) > 0 ? '+' : ''}{pair.gamesDiff || 0}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* –ú–∞—Ç—á–∏ */}
                    <div className="space-y-3">
                        {[1, 2, 3].map(round => {
                            const rm = group.matches.filter(m => m.round === round);
                            return rm.length > 0 && (
                                <div key={round}>
                                    <div className="text-white font-bold mb-2 text-xs md:text-sm opacity-90">
                                        –†–ê–£–ù–î {round}
                                    </div>
                                    {rm.map((m, idx) => (
                                        <MatchCard 
                                            key={idx} 
                                            match={m} 
                                            onEdit={() => setEditingMatch({ match: m, idx: group.matches.indexOf(m) })} 
                                            isAdmin={isAdmin} 
                                        />
                                    ))}
                                </div>
                            );
                        })}
                    </div>
                    
                    {editingMatch && (
                        <window.ScoreModal 
                            match={editingMatch.match} 
                            onSave={(r) => { 
                                onUpdateMatch(group.id, editingMatch.idx, r, stage); 
                                setEditingMatch(null); 
                            }} 
                            onClose={() => setEditingMatch(null)} 
                        />
                    )}
                </div>
            );
        }

        // StageView —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º grid
        function StageView({ groups, stage, onUpdateMatch, isAdmin }) {
            const colors = [
                'from-rose-500 to-pink-500', 
                'from-blue-500 to-cyan-500', 
                'from-emerald-500 to-teal-500', 
                'from-purple-500 to-indigo-500'
            ];
            
            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    {groups?.map((g, i) => (
                        <GroupView 
                            key={g.id} 
                            group={g} 
                            stage={stage} 
                            onUpdateMatch={onUpdateMatch} 
                            colorClass={colors[i % colors.length]} 
                            isAdmin={isAdmin} 
                        />
                    ))}
                </div>
            );
        }

        // MOBILE-FIRST TableView
        function TableView({ groups, onNext, showNext }) {
            const allPairs = groups?.flatMap(g => 
                g.pairs.map(p => ({ ...p, group: g.name }))
            ).sort((a, b) => 
                b.points - a.points || b.gamesDiff - a.gamesDiff
            ) || [];
            
            return (
                <div className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-2xl">
                    <h3 className="text-2xl md:text-3xl font-black text-white mb-4 md:mb-6">
                        –û–ë–©–ê–Ø –¢–ê–ë–õ–ò–¶–ê
                    </h3>
                    
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl md:rounded-2xl overflow-hidden mb-6">
                        <div className="table-scroll">
                            <table className="w-full text-white min-w-[500px]">
                                <thead>
                                    <tr className="border-b border-white border-opacity-30">
                                        <th className="p-3 md:p-4 text-left font-bold">–ú</th>
                                        <th className="p-3 md:p-4 text-left font-bold">–ì—Ä</th>
                                        <th className="p-3 md:p-4 text-left font-bold">–ü–∞—Ä–∞</th>
                                        <th className="p-3 md:p-4 text-center font-bold">–û</th>
                                        <th className="p-3 md:p-4 text-center font-bold">+/-</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {allPairs.map((p, i) => (
                                        <tr key={p.id} className="border-b border-white border-opacity-20">
                                            <td className="p-3 md:p-4">
                                                <span className="font-black text-xl md:text-2xl">
                                                    {i + 1}
                                                </span>
                                            </td>
                                            <td className="p-3 md:p-4 font-bold">{p.group}</td>
                                            <td className="p-3 md:p-4">
                                                <div className="font-bold">#{p.number}</div>
                                                <div className="text-sm opacity-90 truncate max-w-[150px]">
                                                    {p.player1}/{p.player2}
                                                </div>
                                            </td>
                                            <td className="p-3 md:p-4 text-center">
                                                <span className="font-black text-lg md:text-xl">
                                                    {p.points}
                                                </span>
                                            </td>
                                            <td className={`p-3 md:p-4 text-center font-bold text-base md:text-lg ${p.gamesDiff > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                {p.gamesDiff > 0 ? '+' : ''}{p.gamesDiff}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {showNext && (
                        <button 
                            className={window.cn(
                                'w-full bg-white text-purple-600',
                                'px-6 md:px-8 py-4 min-h-[52px]',
                                'rounded-xl md:rounded-2xl',
                                'font-black text-base md:text-lg',
                                'active:shadow-2xl transition-all'
                            )}
                            onClick={onNext}
                        >
                            –≠–¢–ê–ü 2 ‚Üí
                        </button>
                    )}
                </div>
            );
        }

        // MOBILE-FIRST FinalView
        function FinalView({ groups, onComplete, isCompleted, isAdmin }) {
            const finalStandings = [];
            groups?.forEach((g, gIdx) => {
                [...g.pairs].sort((a, b) => 
                    b.points - a.points || b.gamesDiff - a.gamesDiff
                ).forEach((p, pIdx) => 
                    finalStandings.push({ ...p, finalPlace: gIdx * 4 + pIdx + 1 })
                );
            });
            finalStandings.sort((a, b) => a.finalPlace - b.finalPlace);

            return (
                <div className="bg-gradient-to-br from-yellow-500 via-orange-500 to-red-500 rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-2xl">
                    <h3 className="text-3xl md:text-4xl font-black text-white mb-4 md:mb-6 text-center">
                        üèÜ –§–ò–ù–ê–õ
                    </h3>
                    
                    <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl md:rounded-2xl overflow-hidden mb-6">
                        <div className="table-scroll">
                            <table className="w-full text-white min-w-[450px]">
                                <thead>
                                    <tr className="border-b border-white border-opacity-30">
                                        <th className="p-3 md:p-4 text-left font-bold">–ú–µ—Å—Ç–æ</th>
                                        <th className="p-3 md:p-4 text-left font-bold">–ü–∞—Ä–∞</th>
                                        <th className="p-3 md:p-4 text-center font-bold">–û—á–∫–∏</th>
                                        <th className="p-3 md:p-4 text-center font-bold">+/-</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {finalStandings.map(p => (
                                        <tr key={p.id} className="border-b border-white border-opacity-20">
                                            <td className="p-3 md:p-4">
                                                <span className={window.cn(
                                                    'inline-flex items-center justify-center',
                                                    'w-10 h-10 md:w-12 md:h-12',
                                                    'rounded-full font-black text-lg md:text-xl', 
                                                    p.finalPlace === 1 ? 'bg-yellow-300 text-yellow-900' : 
                                                    p.finalPlace === 2 ? 'bg-gray-300 text-gray-900' : 
                                                    p.finalPlace === 3 ? 'bg-orange-300 text-orange-900' : 
                                                    'bg-white bg-opacity-50'
                                                )}>
                                                    {p.finalPlace}
                                                </span>
                                            </td>
                                            <td className="p-3 md:p-4">
                                                <div className="font-bold text-base md:text-lg">
                                                    #{p.number}
                                                </div>
                                                <div className="text-sm opacity-90 truncate max-w-[150px]">
                                                    {p.player1}/{p.player2}
                                                </div>
                                            </td>
                                            <td className="p-3 md:p-4 text-center">
                                                <span className="font-black text-xl md:text-2xl">
                                                    {p.points}
                                                </span>
                                            </td>
                                            <td className={`p-3 md:p-4 text-center font-bold text-lg md:text-xl ${p.gamesDiff > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                                {p.gamesDiff > 0 ? '+' : ''}{p.gamesDiff}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {!isCompleted && isAdmin && (
                        <button 
                            className={window.cn(
                                'w-full bg-white text-orange-600',
                                'px-6 md:px-8 py-4 min-h-[52px]',
                                'rounded-xl md:rounded-2xl',
                                'font-black text-base md:text-lg',
                                'active:bg-gray-50 transition-all'
                            )}
                            onClick={onComplete}
                        >
                            ‚úì –ó–ê–í–ï–†–®–ò–¢–¨
                        </button>
                    )}
                    
                    {isCompleted && (
                        <div className="text-center py-8 bg-white bg-opacity-20 rounded-2xl">
                            <div className="text-5xl md:text-6xl mb-4">üèÜ</div>
                            <div className="text-white text-2xl md:text-3xl font-black">
                                –ó–ê–í–ï–†–®–Å–ù!
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // MOBILE-FIRST TournamentInfo
        function TournamentInfo({ tournament, isAdmin, user, isUserRegistered, onRegister, onUnregister, onStartTournament }) {
            const rp = tournament.registeredPlayers || [];
            const pairs = tournament.format === 'fixed' 
                ? Array(Math.ceil(rp.length / 2)).fill().map((_, i) => ({ 
                    p1: rp[i * 2], 
                    p2: rp[i * 2 + 1], 
                    num: i + 1 
                })) 
                : [];

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    {/* –î–µ—Ç–∞–ª–∏ —Ç—É—Ä–Ω–∏—Ä–∞ */}
                    <div className="space-y-4 md:space-y-6">
                        <window.Card className="p-6 md:p-8 space-y-4 md:space-y-5">
                            <h3 className="text-xs md:text-sm font-medium text-gray-400 uppercase tracking-wider mb-4 md:mb-6">
                                –î–µ—Ç–∞–ª–∏
                            </h3>
                            
                            {tournament.date && (
                                <div className="flex items-center gap-3 md:gap-4">
                                    <span className="text-xl md:text-2xl">üìÖ</span>
                                    <div>
                                        <div className="text-xs text-gray-400">–î–∞—Ç–∞</div>
                                        <div className="text-base md:text-lg font-medium text-black">
                                            {window.formatDate(tournament.date, { 
                                                weekday: 'long', 
                                                day: 'numeric', 
                                                month: 'long' 
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tournament.time && (
                                <div className="flex items-center gap-3 md:gap-4">
                                    <span className="text-xl md:text-2xl">üïê</span>
                                    <div>
                                        <div className="text-xs text-gray-400">–í—Ä–µ–º—è</div>
                                        <div className="text-base md:text-lg font-medium text-black">
                                            {tournament.time}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tournament.location && (
                                <div className="flex items-center gap-3 md:gap-4">
                                    <span className="text-xl md:text-2xl">üìç</span>
                                    <div className="flex-1">
                                        <div className="text-xs text-gray-400">–õ–æ–∫–∞—Ü–∏—è</div>
                                        <div className="text-base md:text-lg font-medium text-black break-words">
                                            {tournament.location}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tournament.price && (
                                <div className="flex items-center gap-3 md:gap-4">
                                    <span className="text-xl md:text-2xl">üí∞</span>
                                    <div>
                                        <div className="text-xs text-gray-400">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                        <div className="text-base md:text-lg font-medium text-black">
                                            {tournament.price}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </window.Card>
                        
                        {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                        {!tournament.stage1Groups && (
                            <div className="space-y-3 md:space-y-4">
                                {isUserRegistered ? (
                                    <window.Button 
                                        variant="danger" 
                                        onClick={onUnregister} 
                                        className="w-full"
                                    >
                                        –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                                    </window.Button>
                                ) : (
                                    <window.Button 
                                        onClick={onRegister} 
                                        className="w-full text-base md:text-lg"
                                    >
                                        {user ? '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏'}
                                    </window.Button>
                                )}
                                
                                {isAdmin && rp.length >= 1 && (
                                    <window.Button 
                                        variant="secondary" 
                                        onClick={onStartTournament} 
                                        className="w-full"
                                    >
                                        üöÄ –ù–∞—á–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                                    </window.Button>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */}
                    <window.Card className="p-6 md:p-8">
                        <div className="flex justify-between items-center mb-4 md:mb-6">
                            <h3 className="text-xs md:text-sm font-medium text-gray-400 uppercase tracking-wider">
                                {tournament.format === 'fixed' ? '–ü–∞—Ä—ã' : '–£—á–∞—Å—Ç–Ω–∏–∫–∏'}
                            </h3>
                            <span className="text-xl md:text-2xl font-bold text-black">
                                {rp.length}
                                <span className="text-gray-400 font-normal">
                                    /{tournament.maxPlayers || '‚àû'}
                                </span>
                            </span>
                        </div>
                        
                        {rp.length === 0 ? (
                            <div className="text-center py-12 md:py-16">
                                <div className="text-4xl md:text-5xl mb-4 opacity-20">üë•</div>
                                <p className="text-gray-400 text-sm md:text-base">
                                    –ù–∏–∫—Ç–æ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è
                                </p>
                            </div>
                        ) : tournament.format === 'fixed' ? (
                            <div className="space-y-3 md:space-y-4 max-h-96 overflow-y-auto">
                                {pairs.map((pair, i) => (
                                    <div key={i} className="bg-gray-50 rounded-xl md:rounded-2xl p-3 md:p-4">
                                        <div className="text-xs text-gray-400 mb-2 font-medium">
                                            –ü–∞—Ä–∞ {pair.num}
                                        </div>
                                        <div className="space-y-2">
                                            {[pair.p1, pair.p2].map((p, j) => p ? (
                                                <div key={j} className="flex items-center gap-3">
                                                    <window.Avatar src={p.photoURL} name={p.name} size="sm" />
                                                    <div className="flex-1 font-medium text-black text-sm md:text-base">
                                                        {p.name}
                                                    </div>
                                                    {user?.uid === p.id && (
                                                        <span className="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded-full">
                                                            –í—ã
                                                        </span>
                                                    )}
                                                </div>
                                            ) : (
                                                <div key={j} className="flex items-center gap-3 opacity-50">
                                                    <div className="w-8 h-8 md:w-10 md:h-10 bg-gray-200 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300 text-gray-400">
                                                        ?
                                                    </div>
                                                    <div className="text-gray-400 italic text-sm md:text-base">
                                                        –û–∂–∏–¥–∞–µ—Ç—Å—è...
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-2 md:space-y-3 max-h-96 overflow-y-auto">
                                {rp.map((p, i) => (
                                    <div 
                                        key={p.id} 
                                        className="flex items-center gap-3 md:gap-4 p-3 rounded-xl md:rounded-2xl active:bg-gray-50"
                                    >
                                        <div className="w-7 h-7 md:w-8 md:h-8 rounded-full bg-black text-white flex items-center justify-center text-xs md:text-sm font-bold">
                                            {i + 1}
                                        </div>
                                        <window.Avatar src={p.photoURL} name={p.name} size="sm" />
                                        <div className="flex-1 font-medium text-black text-sm md:text-base">
                                            {p.name}
                                        </div>
                                        {user?.uid === p.id && (
                                            <span className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">
                                                –í—ã
                                            </span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </window.Card>
                </div>
            );
        }

        // MOBILE-FIRST TournamentView
        function TournamentView() {
            const id = new URLSearchParams(window.location.search).get('id');
            const { user, isAdmin, showAuth } = window.useAuth();
            const t = window.useDocument('tournaments', id);
            const ready = window.useFirebaseReady();
            const [tab, setTab] = useState('info');
            const [showPairsEditor, setShowPairsEditor] = useState(false);
            const isMobile = window.useIsMobile();

            if (!ready || !t) {
                return <div className="text-white text-center py-12">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
            }

            const isRegistered = t.registeredPlayers?.some(p => p.id === user?.uid);

            const register = async () => {
                if (!user) { showAuth(); return; }
                if ((t.registeredPlayers?.length || 0) >= t.maxPlayers) {
                    return alert('–ú–µ—Å—Ç –Ω–µ—Ç');
                }
                await window.fb.doc('tournaments', id).update({ 
                    registeredPlayers: window.fb.arrayUnion({ 
                        id: user.uid, 
                        name: user.displayName || '–ò–≥—Ä–æ–∫', 
                        email: user.email, 
                        photoURL: user.photoURL, 
                        registeredAt: new Date().toISOString() 
                    })
                });
            };

            const unregister = async () => {
                const p = t.registeredPlayers?.find(p => p.id === user?.uid);
                if (p) {
                    await window.fb.doc('tournaments', id).update({ 
                        registeredPlayers: window.fb.arrayRemove(p) 
                    });
                }
            };

            const confirmPairs = async (pairs) => {
                await window.fb.doc('tournaments', id).update({ 
                    status: 'stage1', 
                    pairs, 
                    stage1Groups: window.generateGroups(pairs, t.courts || 2) 
                });
                setShowPairsEditor(false); 
                setTab('stage1');
            };

            const updateMatch = async (groupId, matchIdx, result, stage) => {
                const field = stage === 1 ? 'stage1Groups' : 'stage2Groups';
                const groups = [...t[field]];
                Object.assign(groups[groupId].matches[matchIdx], result);
                window.recalcGroup(groups[groupId]);
                await window.fb.doc('tournaments', id).update({ [field]: groups });
            };

            const generateStage2 = async () => {
                const allPairs = t.stage1Groups.flatMap(g => g.pairs)
                    .sort((a, b) => b.points - a.points || b.gamesDiff - a.gamesDiff);
                await window.fb.doc('tournaments', id).update({ 
                    stage2Groups: window.generateGroups(
                        allPairs.map(p => ({ 
                            id: p.id, 
                            number: p.number, 
                            player1: p.player1, 
                            player2: p.player2, 
                            player1Id: p.player1Id, 
                            player2Id: p.player2Id 
                        })), 
                        t.courts
                    ), 
                    status: 'stage2' 
                });
                setTab('stage2');
            };

            const complete = async () => {
                const players = t.registeredPlayers || [];
                const allPairs = t.stage2Groups?.flatMap(g => g.pairs) || [];
                
                for (const p of players) {
                    const pair = allPairs.find(pr => pr.player1Id === p.id || pr.player2Id === p.id);
                    if (pair) {
                        await window.fb.doc('players', p.id).update({
                            tournamentsPlayed: window.fb.increment(1),
                            totalMatches: window.fb.increment(pair.played || 0),
                            wins: window.fb.increment(pair.won || 0),
                            losses: window.fb.increment(pair.lost || 0),
                            points: window.fb.increment(pair.points || 0)
                        });
                    }
                }
                
                await window.fb.doc('tournaments', id).update({ 
                    status: 'completed', 
                    completedAt: new Date().toISOString() 
                });
            };

            const tabs = [
                'info', 
                ...(t.stage1Groups ? ['stage1', 'table1'] : []), 
                ...(t.stage2Groups ? ['stage2', 'final'] : [])
            ];
            
            const tabLabels = { 
                info: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', 
                stage1: '–≠—Ç–∞–ø 1', 
                table1: '–¢–∞–±–ª–∏—Ü–∞', 
                stage2: '–≠—Ç–∞–ø 2', 
                final: '–§–∏–Ω–∞–ª' 
            };

            if (showPairsEditor) {
                return (
                    <PairsEditor 
                        players={t.registeredPlayers || []} 
                        courts={t.courts || 2} 
                        onConfirm={confirmPairs} 
                        onCancel={() => setShowPairsEditor(false)} 
                    />
                );
            }

            return (
                <div>
                    {/* Header */}
                    <div className="flex items-center justify-between mb-6 md:mb-8">
                        <div className="flex items-center gap-4 md:gap-6 flex-1 min-w-0">
                            <a 
                                href="./index.html" 
                                className="text-white/40 active:text-white text-xl md:text-2xl no-underline min-w-[44px] min-h-[44px] flex items-center justify-center"
                            >
                                ‚Üê
                            </a>
                            <div className="min-w-0 flex-1">
                                <h2 className="text-xl md:text-3xl font-bold truncate">
                                    {t.name}
                                </h2>
                                <div className="flex items-center gap-2 md:gap-3 mt-1 flex-wrap">
                                    {(t.status === 'stage1' || t.status === 'stage2') && (
                                        <window.Badge variant="active">LIVE</window.Badge>
                                    )}
                                    <span className="text-white/40 text-xs md:text-sm">
                                        {t.format === 'fixed' 
                                            ? 'üë´ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã' 
                                            : 'üîÑ –°–º–µ–Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Tabs - horizontal scroll */}
                    <div className="flex gap-2 mb-6 md:mb-8 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0">
                        {tabs.map(t => (
                            <window.Tab 
                                key={t} 
                                active={tab === t} 
                                onClick={() => setTab(t)}
                            >
                                {tabLabels[t]}
                            </window.Tab>
                        ))}
                    </div>

                    {/* Content */}
                    {tab === 'info' && (
                        <TournamentInfo 
                            tournament={t} 
                            isAdmin={isAdmin} 
                            user={user} 
                            isUserRegistered={isRegistered} 
                            onRegister={register} 
                            onUnregister={unregister} 
                            onStartTournament={() => setShowPairsEditor(true)} 
                        />
                    )}
                    {tab === 'stage1' && (
                        <StageView 
                            groups={t.stage1Groups} 
                            stage={1} 
                            onUpdateMatch={updateMatch} 
                            isAdmin={isAdmin} 
                        />
                    )}
                    {tab === 'table1' && (
                        <TableView 
                            groups={t.stage1Groups} 
                            onNext={generateStage2} 
                            showNext={isAdmin && !t.stage2Groups} 
                        />
                    )}
                    {tab === 'stage2' && (
                        <StageView 
                            groups={t.stage2Groups} 
                            stage={2} 
                            onUpdateMatch={updateMatch} 
                            isAdmin={isAdmin} 
                        />
                    )}
                    {tab === 'final' && (
                        <FinalView 
                            groups={t.stage2Groups} 
                            onComplete={complete} 
                            isCompleted={t.status === 'completed'} 
                            isAdmin={isAdmin} 
                        />
                    )}
                </div>
            );
        }

        function App() {
            const auth = window.useAuthState();
            return (
                <window.AuthContext.Provider value={auth}>
                    <window.Layout activePage="tournaments">
                        <TournamentView />
                    </window.Layout>
                </window.AuthContext.Provider>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
